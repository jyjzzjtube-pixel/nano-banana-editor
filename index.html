<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>ğŸŒ ë‚˜ë…¸ë°”ë‚˜ë‚˜ ì—ë””í„° v3</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#08080d; --sf:#101018; --sf2:#181824; --sf3:#222236;
  --banana:#FFD60A; --accent:#FF6B35; --ok:#00E676; --err:#FF5252;
  --txt:#E8E8F0; --dim:#6E6E8A; --bd:#2A2A3E; --r:10px;
  --mask:rgba(255,107,53,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:var(--sf3);border-radius:4px;}

/* HEADER */
.hd{background:var(--sf);border-bottom:1px solid var(--bd);padding:12px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100;}
.hd-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--banana),var(--accent));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 2px 12px rgba(255,214,10,0.3);}
.hd h1{font-size:16px;font-weight:900;background:linear-gradient(135deg,var(--banana),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hd small{font-size:9px;color:var(--dim);display:block;font-weight:400;}

/* API */
.api{padding:10px 16px;background:var(--sf);border-bottom:1px solid var(--bd);display:flex;gap:8px;align-items:center;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--err);flex-shrink:0;transition:0.3s;}
.dot.on{background:var(--ok);box-shadow:0 0 8px rgba(0,230,118,0.5);}
.api-in{flex:1;background:var(--sf2);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;color:var(--txt);font-size:12px;font-family:'JetBrains Mono',monospace;outline:none;}
.api-in:focus{border-color:var(--banana);}
.m-sel{background:var(--sf2);border:1px solid var(--bd);border-radius:6px;padding:8px 10px;color:var(--txt);font-size:11px;outline:none;cursor:pointer;}

/* WORKSPACE */
.ws{position:relative;margin:12px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;display:flex;flex-direction:column;}

/* Upload */
.upl{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;z-index:5;transition:0.3s;}
.upl.hide{opacity:0;pointer-events:none;}
.upl .ic{font-size:56px;opacity:0.5;margin-bottom:12px;}
.upl .t1{font-size:14px;color:var(--dim);font-weight:500;}
.upl .t2{font-size:11px;color:var(--dim);opacity:0.5;margin-top:4px;}

/* Canvas */
.cw{position:relative;width:100%;flex:1;min-height:300px;overflow:hidden;cursor:crosshair;touch-action:none;}
.cw canvas{position:absolute;top:0;left:0;transform-origin:0 0;}
#ic{z-index:1;}#mc{z-index:2;}#uc{z-index:3;pointer-events:none;}

/* Toolbar */
.tb{display:none;padding:8px 12px;background:var(--sf2);border-top:1px solid var(--bd);gap:6px;align-items:center;flex-wrap:wrap;}
.tb.v{display:flex;}
.tbtn{padding:6px 12px;background:var(--sf3);border:1px solid var(--bd);border-radius:6px;color:var(--dim);font-size:12px;cursor:pointer;transition:0.15s;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;display:flex;align-items:center;gap:4px;}
.tbtn:hover{border-color:var(--dim);color:var(--txt);}
.tbtn.a{background:var(--banana);color:var(--bg);border-color:var(--banana);font-weight:700;}
.sep{width:1px;height:24px;background:var(--bd);margin:0 4px;}
.bsw{display:flex;align-items:center;gap:6px;}
.bsw label{font-size:11px;color:var(--dim);}
.bsl{-webkit-appearance:none;width:80px;height:4px;background:var(--bd);border-radius:2px;outline:none;}
.bsl::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--banana);border-radius:50%;cursor:pointer;}
.zi{margin-left:auto;font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace;}

/* â•â•â• COMMAND BAR (í•µì‹¬: í…ìŠ¤íŠ¸ ì…ë ¥ + ì‹¤í–‰) â•â•â• */
.cmd{display:none;margin:12px;background:var(--sf);border:2px solid var(--banana);border-radius:var(--r);overflow:hidden;box-shadow:0 4px 20px rgba(255,214,10,0.1);}
.cmd.v{display:block;}

.cmd-label{padding:10px 14px 0;font-size:12px;font-weight:700;color:var(--banana);display:flex;align-items:center;gap:6px;}
.cmd-label .mask-indicator{font-size:11px;color:var(--accent);font-weight:400;margin-left:auto;}

.cmd-body{padding:10px 14px 14px;}

.cmd-ta{width:100%;background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:12px 14px;color:var(--txt);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;resize:vertical;min-height:70px;line-height:1.6;}
.cmd-ta:focus{border-color:var(--banana);}
.cmd-ta::placeholder{color:var(--dim);}

.chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;}
.chip{padding:5px 12px;background:var(--sf3);border:1px solid var(--bd);border-radius:16px;font-size:11px;color:var(--dim);cursor:pointer;transition:0.15s;}
.chip:hover{background:var(--banana);color:var(--bg);border-color:var(--banana);}

.cmd-exec{margin-top:12px;width:100%;padding:14px;background:linear-gradient(135deg,var(--banana),var(--accent));color:var(--bg);border:none;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:0.2s;font-family:'Noto Sans KR',sans-serif;}
.cmd-exec:hover{box-shadow:0 6px 24px rgba(255,214,10,0.4);transform:translateY(-1px);}
.cmd-exec:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none;}
.cmd-exec .sp{display:none;width:18px;height:18px;border:3px solid rgba(0,0,0,0.15);border-top-color:var(--bg);border-radius:50%;animation:sp 0.7s linear infinite;}
.cmd-exec.ld .sp{display:block;}
.cmd-exec.ld .bl{display:none;}
@keyframes sp{to{transform:rotate(360deg);}}

/* HISTORY BAR */
.hist{display:none;margin:0 12px 8px;padding:10px 14px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);}
.hist.v{display:block;}
.hist-title{font-size:10px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;}
.hist-list{display:flex;flex-direction:column;gap:6px;}
.hist-item{display:flex;align-items:center;gap:10px;padding:6px 8px;background:var(--sf2);border-radius:6px;font-size:11px;cursor:pointer;transition:0.15s;border:1px solid transparent;}
.hist-item:hover{border-color:var(--bd);}
.hist-item .hn{width:20px;height:20px;border-radius:5px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;flex-shrink:0;}
.hist-item .ht{flex:1;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hist-item .hx{color:var(--err);cursor:pointer;font-size:14px;padding:0 4px;}

/* RESULT */
.res{display:none;margin:12px;background:var(--sf);border:1px solid var(--ok);border-radius:var(--r);overflow:hidden;}
.res.v{display:block;}
.res-bar{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);}
.res-bar span{font-size:13px;font-weight:700;}
.res-acts{display:flex;gap:6px;}
.rb{padding:6px 12px;background:var(--sf3);border:1px solid var(--bd);border-radius:6px;color:var(--txt);font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:0.15s;}
.rb:hover{background:var(--banana);color:var(--bg);border-color:var(--banana);}
.res-img{padding:8px;text-align:center;}
.res-img img{max-width:100%;max-height:500px;border-radius:8px;}

/* GUIDE */
.guide{margin:12px;padding:14px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);font-size:12px;color:var(--dim);line-height:1.8;}
.guide.hide{display:none;}
.guide strong{color:var(--banana);}
.sn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--banana);color:var(--bg);font-size:11px;font-weight:900;margin-right:6px;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);padding:12px 24px;border-radius:10px;font-size:13px;font-weight:500;z-index:9999;transition:transform 0.3s;max-width:90%;text-align:center;background:var(--err);color:#fff;}
.toast.ok{background:var(--ok);color:var(--bg);}
.toast.s{transform:translateX(-50%) translateY(0);}

@media(min-width:768px){.ws,.cmd,.hist,.res,.guide{max-width:640px;margin-left:auto;margin-right:auto;}}
</style>
</head>
<body>

<header class="hd">
  <div class="hd-icon">ğŸŒ</div>
  <div><h1>NANO BANANA EDITOR</h1><small>ì˜ì—­ ì¹ í•˜ê¸° â†’ ì§€ì‹œ ì…ë ¥ â†’ ì‹¤í–‰</small></div>
</header>

<div class="api">
  <div class="dot" id="dot"></div>
  <input class="api-in" id="apiKey" type="password" placeholder="Gemini API Key" value="AIzaSyCt9Y8dI-i7sb0TjhM7Z9S3y7cnnGCejRc">
  <select class="m-sel" id="mdl">
    <option value="gemini-2.5-flash-preview-05-20">âš¡ Flash</option>
    <option value="gemini-2.5-pro-preview-05-06">ğŸ§  Pro</option>
  </select>
</div>

<div class="ws" id="ws">
  <div class="upl" id="upl">
    <div class="ic">ğŸ“¸</div>
    <div class="t1">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
    <div class="t2">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ Â· ìµœëŒ€ 10MB</div>
  </div>
  <input type="file" id="fi" accept="image/*" hidden>

  <div class="cw" id="cw">
    <canvas id="ic"></canvas>
    <canvas id="mc"></canvas>
    <canvas id="uc"></canvas>
  </div>

  <div class="tb" id="tb">
    <button class="tbtn a" data-tool="brush">ğŸ–Œï¸ ë¸ŒëŸ¬ì‹œ</button>
    <button class="tbtn" data-tool="rect">â¬œ ì‚¬ê°í˜•</button>
    <button class="tbtn" data-tool="eraser">ğŸ§¹ ì§€ìš°ê°œ</button>
    <div class="sep"></div>
    <div class="bsw">
      <label>êµµê¸°</label>
      <input type="range" class="bsl" id="bs" min="5" max="120" value="30">
    </div>
    <div class="sep"></div>
    <button class="tbtn" id="undoB">â†©ï¸</button>
    <button class="tbtn" id="clearB">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    <div class="sep"></div>
    <button class="tbtn" id="ziB">ğŸ”+</button>
    <button class="tbtn" id="zoB">ğŸ”-</button>
    <button class="tbtn" id="zfB">âŠ</button>
    <span class="zi" id="zI">100%</span>
  </div>
</div>

<div class="guide" id="guide">
  <span class="sn">1</span> ì´ë¯¸ì§€ ì—…ë¡œë“œ<br>
  <span class="sn">2</span> <strong>ë¸ŒëŸ¬ì‹œ/ì‚¬ê°í˜•</strong>ìœ¼ë¡œ ìˆ˜ì •í•  ì˜ì—­ì„ ì¹ í•˜ì„¸ìš”<br>
  <span class="sn">3</span> ì•„ë˜ í…ìŠ¤íŠ¸ì°½ì— <strong>ìˆ˜ì • ì§€ì‹œ</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”<br>
  <span class="sn">4</span> <strong>í¸ì§‘ ì‹¤í–‰</strong> â†’ ë‚˜ë…¸ë°”ë‚˜ë‚˜ê°€ ì¹ í•œ ì˜ì—­ë§Œ ìˆ˜ì •í•©ë‹ˆë‹¤
</div>

<!-- â•â•â• COMMAND BAR â•â•â• -->
<div class="cmd" id="cmd">
  <div class="cmd-label">
    âœï¸ ìˆ˜ì • ì§€ì‹œ ì…ë ¥
    <span class="mask-indicator" id="maskInd">ì˜ì—­ ë¯¸ì„ íƒ</span>
  </div>
  <div class="cmd-body">
    <textarea class="cmd-ta" id="cmdTa" placeholder="ì¹ í•œ ì˜ì—­ì„ ì–´ë–»ê²Œ ìˆ˜ì •í• ê¹Œìš”?&#10;&#10;ì˜ˆì‹œ:&#10;â€¢ ì´ ë¶€ë¶„ ë°ê¸° ì˜¬ë ¤ì¤˜&#10;â€¢ ì—¬ê¸° ì‚¬ëŒ ì§€ì›Œì¤˜&#10;â€¢ ë°°ê²½ì„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë°”ê¿”ì¤˜&#10;â€¢ ì£¼ë¦„ ì œê±°í•´ì¤˜&#10;â€¢ ê¸€ìë¥¼ 'ì˜¤í”ˆ ì´ë²¤íŠ¸'ë¡œ ë°”ê¿”ì¤˜"></textarea>
    <div class="chips">
      <span class="chip" data-c="ë°ê¸° ì˜¬ë ¤ì¤˜">ğŸ’¡ ë°ê¸°â†‘</span>
      <span class="chip" data-c="ì„ ëª…í•˜ê²Œ í•´ì¤˜">ğŸ” ì„ ëª…í•˜ê²Œ</span>
      <span class="chip" data-c="ì´ ë¶€ë¶„ ì œê±°í•´ì¤˜">ğŸ—‘ï¸ ê°ì²´ ì œê±°</span>
      <span class="chip" data-c="ë°°ê²½ ë¸”ëŸ¬ ì²˜ë¦¬í•´ì¤˜">ğŸŒ«ï¸ ë¸”ëŸ¬</span>
      <span class="chip" data-c="í”¼ë¶€ ë³´ì •í•´ì¤˜">âœ¨ í”¼ë¶€ë³´ì •</span>
      <span class="chip" data-c="ìƒ‰ê° ë”°ëœ»í•˜ê²Œ">ğŸ”¥ ì›œí†¤</span>
      <span class="chip" data-c="ìƒ‰ê° ì°¨ê°‘ê²Œ">â„ï¸ ì¿¨í†¤</span>
      <span class="chip" data-c="ë…¸ì´ì¦ˆ ì œê±°í•´ì¤˜">ğŸ§¹ ë…¸ì´ì¦ˆì œê±°</span>
      <span class="chip" data-c="ì¡í‹° ì œê±°í•´ì¤˜">ğŸª„ ì¡í‹°ì œê±°</span>
      <span class="chip" data-c="ì´ ê¸€ìë¥¼ ìˆ˜ì •í•´ì¤˜:">âœï¸ í…ìŠ¤íŠ¸ìˆ˜ì •</span>
      <span class="chip" data-c="ê³ ê¸‰ìŠ¤ëŸ½ê²Œ ë³´ì •í•´ì¤˜">ğŸ’ ëŸ­ì…”ë¦¬</span>
      <span class="chip" data-c="ê·¸ë¦¼ì ìì—°ìŠ¤ëŸ½ê²Œ ì¶”ê°€">ğŸŒ‘ ê·¸ë¦¼ì</span>
    </div>
    <button class="cmd-exec" id="execB" disabled>
      <span class="bl">ğŸŒ í¸ì§‘ ì‹¤í–‰</span>
      <div class="sp"></div>
    </button>
  </div>
</div>

<!-- EDIT HISTORY -->
<div class="hist" id="hist">
  <div class="hist-title">ğŸ“‹ í¸ì§‘ íˆìŠ¤í† ë¦¬</div>
  <div class="hist-list" id="histList"></div>
</div>

<!-- RESULT -->
<div class="res" id="res">
  <div class="res-bar">
    <span>âœ… í¸ì§‘ ê²°ê³¼</span>
    <div class="res-acts">
      <button class="rb" onclick="dl()">ğŸ’¾ ì €ì¥</button>
      <button class="rb" onclick="reuse()">ğŸ”„ ì¬í¸ì§‘</button>
    </div>
  </div>
  <div class="res-img"><img id="resImg"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const $=id=>document.getElementById(id);
const S={img:null,b64:null,mime:null,tool:'brush',bs:30,zoom:1,px:0,py:0,drawing:false,panning:false,hist:[],editLog:[],rectStart:null,resultB64:null};
const ic=$('ic'),mc=$('mc'),uc=$('uc');
const ix=ic.getContext('2d'),mx=mc.getContext('2d'),ux=uc.getContext('2d');
const cw=$('cw');

// â”€â”€â”€ FILE â”€â”€â”€
$('upl').onclick=()=>$('fi').click();
$('fi').onchange=e=>{if(e.target.files[0])loadF(e.target.files[0]);};
$('ws').ondragover=e=>e.preventDefault();
$('ws').ondrop=e=>{e.preventDefault();if(e.dataTransfer.files[0])loadF(e.dataTransfer.files[0]);};

function loadF(f){
  if(f.size>10*1024*1024)return toast('10MB ì´ˆê³¼');
  const r=new FileReader();
  r.onload=e=>{
    S.mime=f.type; S.b64=e.target.result.split(',')[1];
    const img=new Image();
    img.onload=()=>{S.img=img;initC();$('upl').classList.add('hide');$('tb').classList.add('v');$('cmd').classList.add('v');$('guide').classList.add('hide');upBtn();};
    img.src=e.target.result;
  };
  r.readAsDataURL(f);
}

// â”€â”€â”€ CANVAS â”€â”€â”€
function initC(){
  const w=S.img.width,h=S.img.height;
  [ic,mc,uc].forEach(c=>{c.width=w;c.height=h;});
  const cW=cw.clientWidth,cH=cw.clientHeight||400;
  S.zoom=Math.min(cW/w,cH/h,1);
  S.px=(cW-w*S.zoom)/2;S.py=(cH-h*S.zoom)/2;
  cw.style.height=Math.max(Math.min(h*S.zoom+20,500),280)+'px';
  ix.clearRect(0,0,w,h);ix.drawImage(S.img,0,0);
  mx.clearRect(0,0,w,h);S.hist=[];
  applyT();upMask();
}

function applyT(){
  const t=`translate(${S.px}px,${S.py}px) scale(${S.zoom})`;
  [ic,mc,uc].forEach(c=>c.style.transform=t);
  $('zI').textContent=Math.round(S.zoom*100)+'%';
}

function gp(e){
  const r=cw.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  return{x:(cx-r.left-S.px)/S.zoom,y:(cy-r.top-S.py)/S.zoom};
}

// â”€â”€â”€ MASK STATE â”€â”€â”€
function hasMask(){
  const d=mx.getImageData(0,0,mc.width,mc.height).data;
  for(let i=3;i<d.length;i+=4)if(d[i]>10)return true;
  return false;
}

function upMask(){
  const has=hasMask();
  $('maskInd').textContent=has?'âœ… ì˜ì—­ ì„ íƒë¨':'ì˜ì—­ ë¯¸ì„ íƒ';
  $('maskInd').style.color=has?'var(--ok)':'var(--accent)';
  upBtn();
}

function saveMask(){
  S.hist.push(mx.getImageData(0,0,mc.width,mc.height));
  if(S.hist.length>40)S.hist.shift();
}

// â”€â”€â”€ DRAWING â”€â”€â”€
let lp=null;

function brushAt(x,y,erase){
  mx.globalCompositeOperation=erase?'destination-out':'source-over';
  mx.fillStyle=erase?'rgba(0,0,0,1)':'rgba(255,107,53,0.45)';
  mx.beginPath();
  mx.arc(x,y,S.bs/2,0,Math.PI*2);
  mx.fill();
  mx.globalCompositeOperation='source-over';
}

function interpBrush(a,b,erase){
  const dx=b.x-a.x,dy=b.y-a.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const steps=Math.max(1,Math.ceil(dist/(S.bs/4)));
  for(let i=0;i<=steps;i++){const t=i/steps;brushAt(a.x+dx*t,a.y+dy*t,erase);}
}

function onDown(e){
  if(!S.img)return;
  if(e.button===1){S.panning=true;S._ps={x:e.clientX,y:e.clientY,px:S.px,py:S.py};return;}
  const p=gp(e);S.drawing=true;lp=p;
  if(S.tool==='brush'||S.tool==='eraser'){saveMask();brushAt(p.x,p.y,S.tool==='eraser');}
  else if(S.tool==='rect'){saveMask();S.rectStart=p;}
}

function onMove(e){
  if(!S.img)return;
  const p=gp(e);
  showCursor(p);
  if(S.panning){
    S.px=S._ps.px+(e.clientX-S._ps.x);
    S.py=S._ps.py+(e.clientY-S._ps.y);
    applyT();return;
  }
  if(!S.drawing)return;
  if(S.tool==='brush'||S.tool==='eraser'){
    if(lp)interpBrush(lp,p,S.tool==='eraser');
    lp=p;
  }else if(S.tool==='rect'&&S.rectStart){
    ux.clearRect(0,0,uc.width,uc.height);
    ux.strokeStyle='#FF6B35';ux.lineWidth=2/S.zoom;
    ux.setLineDash([6/S.zoom,4/S.zoom]);
    ux.strokeRect(S.rectStart.x,S.rectStart.y,p.x-S.rectStart.x,p.y-S.rectStart.y);
    ux.setLineDash([]);
  }
}

function onUp(){
  if(S.panning){S.panning=false;return;}
  if(!S.drawing)return;
  S.drawing=false;
  if(S.tool==='rect'&&S.rectStart&&lp){
    mx.fillStyle='rgba(255,107,53,0.45)';
    const x=Math.min(S.rectStart.x,lp.x),y=Math.min(S.rectStart.y,lp.y);
    mx.fillRect(x,y,Math.abs(lp.x-S.rectStart.x),Math.abs(lp.y-S.rectStart.y));
    S.rectStart=null;
    ux.clearRect(0,0,uc.width,uc.height);
  }
  lp=null;upMask();
}

function showCursor(p){
  ux.clearRect(0,0,uc.width,uc.height);
  if((S.tool==='brush'||S.tool==='eraser')&&!S.drawing){
    ux.strokeStyle=S.tool==='eraser'?'rgba(255,82,82,0.7)':'rgba(255,214,10,0.7)';
    ux.lineWidth=1.5/S.zoom;
    ux.beginPath();ux.arc(p.x,p.y,S.bs/2,0,Math.PI*2);ux.stroke();
  }
}

cw.addEventListener('pointerdown',onDown);
cw.addEventListener('pointermove',onMove);
cw.addEventListener('pointerup',onUp);
cw.addEventListener('pointerleave',onUp);
cw.addEventListener('touchstart',e=>{if(e.touches.length===1){e.preventDefault();onDown(e.touches[0]);}},{passive:false});
cw.addEventListener('touchmove',e=>{if(e.touches.length===1){e.preventDefault();onMove(e.touches[0]);}},{passive:false});
cw.addEventListener('touchend',()=>onUp(),{passive:false});

// â”€â”€â”€ ZOOM â”€â”€â”€
cw.addEventListener('wheel',e=>{e.preventDefault();zm(e.deltaY>0?0.9:1.1,e);},{passive:false});
function zm(f,e){
  const r=cw.getBoundingClientRect();
  const mx2=e?(e.clientX||r.left+r.width/2)-r.left:r.width/2;
  const my2=e?(e.clientY||r.top+r.height/2)-r.top:r.height/2;
  const nz=Math.max(0.1,Math.min(10,S.zoom*f));
  S.px=mx2-(mx2-S.px)*(nz/S.zoom);
  S.py=my2-(my2-S.py)*(nz/S.zoom);
  S.zoom=nz;applyT();
}
$('ziB').onclick=()=>zm(1.3);
$('zoB').onclick=()=>zm(0.7);
$('zfB').onclick=()=>{if(!S.img)return;const w=cw.clientWidth,h=cw.clientHeight;S.zoom=Math.min(w/S.img.width,h/S.img.height,1);S.px=(w-S.img.width*S.zoom)/2;S.py=(h-S.img.height*S.zoom)/2;applyT();};

// Pinch
let pd=0;
cw.addEventListener('touchstart',e=>{if(e.touches.length===2){e.preventDefault();const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;pd=Math.sqrt(dx*dx+dy*dy);}},{passive:false});
cw.addEventListener('touchmove',e=>{if(e.touches.length===2){e.preventDefault();const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;const nd=Math.sqrt(dx*dx+dy*dy);zm(nd/pd);pd=nd;}},{passive:false});

// â”€â”€â”€ TOOLBAR â”€â”€â”€
document.querySelectorAll('.tbtn[data-tool]').forEach(b=>{
  b.onclick=()=>{document.querySelectorAll('.tbtn[data-tool]').forEach(x=>x.classList.remove('a'));b.classList.add('a');S.tool=b.dataset.tool;};
});
$('bs').oninput=e=>S.bs=+e.target.value;
$('undoB').onclick=()=>{if(S.hist.length)mx.putImageData(S.hist.pop(),0,0);upMask();};
$('clearB').onclick=()=>{mx.clearRect(0,0,mc.width,mc.height);S.hist=[];upMask();};

// â”€â”€â”€ CHIPS â”€â”€â”€
document.querySelectorAll('.chip').forEach(c=>{
  c.onclick=()=>{
    const ta=$('cmdTa');
    const v=ta.value.trim();
    ta.value=v?(v+', '+c.dataset.c):c.dataset.c;
    ta.focus();
    upBtn();
  };
});

// â”€â”€â”€ EXEC â”€â”€â”€
function upBtn(){
  const ok=!!S.b64&&$('apiKey').value.trim().length>10&&$('cmdTa').value.trim();
  $('execB').disabled=!ok;
}
$('apiKey').oninput=()=>{$('dot').classList.toggle('on',$('apiKey').value.trim().length>10);upBtn();};
$('cmdTa').oninput=upBtn;

$('execB').onclick=exec;

async function exec(){
  const key=$('apiKey').value.trim();
  const mdl=$('mdl').value;
  const txt=$('cmdTa').value.trim();
  if(!key||!S.b64||!txt)return;

  // Build mask image (white = edit area, black = keep)
  const hasMsk=hasMask();
  
  const parts=[];

  // 1. Original image
  parts.push({inline_data:{mime_type:S.mime,data:S.b64}});

  // 2. Mask image (if drawn)
  if(hasMsk){
    const tc=document.createElement('canvas');
    tc.width=mc.width;tc.height=mc.height;
    const tx=tc.getContext('2d');
    tx.fillStyle='#000';tx.fillRect(0,0,tc.width,tc.height);
    const md=mx.getImageData(0,0,mc.width,mc.height).data;
    const td=tx.getImageData(0,0,tc.width,tc.height);
    for(let i=0;i<md.length;i+=4){
      if(md[i+3]>10){td.data[i]=255;td.data[i+1]=255;td.data[i+2]=255;td.data[i+3]=255;}
    }
    tx.putImageData(td,0,0);
    const maskB64=tc.toDataURL('image/png').split(',')[1];
    
    parts.push({inline_data:{mime_type:'image/png',data:maskB64}});
    parts.push({text:`ìœ„ ë‘ ë²ˆì§¸ ì´ë¯¸ì§€ëŠ” ë§ˆìŠ¤í¬ì…ë‹ˆë‹¤. í°ìƒ‰ ì˜ì—­ì´ í¸ì§‘ ëŒ€ìƒ ì˜ì—­ì…ë‹ˆë‹¤.`});
  }

  // 3. Prompt
  let prompt;
  if(hasMsk){
    prompt=`ì´ ì´ë¯¸ì§€ì—ì„œ ë§ˆìŠ¤í¬ì˜ í°ìƒ‰ ì˜ì—­(=ë‚´ê°€ ì„ íƒí•œ ë¶€ë¶„)ë§Œ ë‹¤ìŒê³¼ ê°™ì´ í¸ì§‘í•´ì£¼ì„¸ìš”:\n\n"${txt}"\n\nì¤‘ìš” ê·œì¹™:\n- ë§ˆìŠ¤í¬ í°ìƒ‰ ì˜ì—­ë§Œ ìˆ˜ì •í•˜ê³ , ë‚˜ë¨¸ì§€ ë¶€ë¶„ì€ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”\n- ìˆ˜ì •ì€ ìì—°ìŠ¤ëŸ½ê³  ì „ë¬¸ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤\n- ì›ë³¸ ì´ë¯¸ì§€ì˜ ì „ì²´ì ì¸ ìŠ¤íƒ€ì¼ê³¼ ë¶„ìœ„ê¸°ë¥¼ ìœ ì§€í•˜ì„¸ìš”`;
  }else{
    prompt=`ì´ ì´ë¯¸ì§€ ì „ì²´ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ í¸ì§‘í•´ì£¼ì„¸ìš”:\n\n"${txt}"\n\nì¤‘ìš”: ìˆ˜ì •ì€ ìì—°ìŠ¤ëŸ½ê³  ì „ë¬¸ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`;
  }
  parts.push({text:prompt});

  const btn=$('execB');
  btn.classList.add('ld');btn.disabled=true;

  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${mdl}:generateContent?key=${key}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts}],generationConfig:{responseModalities:['TEXT','IMAGE']}})
    });

    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error?.message||`ì—ëŸ¬ ${res.status}`);}

    const data=await res.json();
    let found=false;

    if(data.candidates?.[0]?.content?.parts){
      for(const p of data.candidates[0].content.parts){
        if(p.inline_data?.mime_type?.startsWith('image/')){
          S.resultB64=p.inline_data.data;
          $('resImg').src=`data:${p.inline_data.mime_type};base64,${p.inline_data.data}`;
          $('res').classList.add('v');
          $('res').scrollIntoView({behavior:'smooth',block:'center'});
          found=true;
          
          // Log to history
          S.editLog.push({text:txt,hasMask:hasMsk,time:new Date().toLocaleTimeString()});
          renderHist();
          
          toast('í¸ì§‘ ì™„ë£Œ! ğŸŒ','ok');
          break;
        }
      }
    }

    if(!found){
      const t=data.candidates?.[0]?.content?.parts?.find(p=>p.text)?.text||'';
      throw new Error(t||'ì´ë¯¸ì§€ ë¯¸ë°˜í™˜. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
    }
  }catch(e){
    toast(e.message);console.error(e);
  }finally{
    btn.classList.remove('ld');upBtn();
  }
}

// â”€â”€â”€ HISTORY â”€â”€â”€
function renderHist(){
  if(!S.editLog.length)return;
  $('hist').classList.add('v');
  $('histList').innerHTML=S.editLog.map((h,i)=>`
    <div class="hist-item">
      <div class="hn">${i+1}</div>
      <div class="ht">${h.hasMask?'ğŸ“Œ ':'ğŸŒ '}${h.text}</div>
      <span style="font-size:10px;color:var(--dim)">${h.time}</span>
    </div>
  `).join('');
}

// â”€â”€â”€ RESULT ACTIONS â”€â”€â”€
function dl(){
  if(!S.resultB64)return;
  const a=document.createElement('a');
  a.href=`data:image/png;base64,${S.resultB64}`;
  a.download=`nanobana_${Date.now()}.png`;
  a.click();toast('ì €ì¥ ì™„ë£Œ','ok');
}

function reuse(){
  if(!S.resultB64)return;
  S.b64=S.resultB64;S.mime='image/png';
  const img=new Image();
  img.onload=()=>{S.img=img;initC();toast('ê²°ê³¼ â†’ ì›ë³¸ ì„¤ì •. ì¶”ê°€ í¸ì§‘ ê°€ëŠ¥!','ok');};
  img.src=`data:image/png;base64,${S.resultB64}`;
  window.scrollTo({top:0,behavior:'smooth'});
}

// â”€â”€â”€ TOAST â”€â”€â”€
function toast(m,t){
  const el=$('toast');el.textContent=m;
  el.className=`toast ${t==='ok'?'ok':''} s`;
  setTimeout(()=>el.classList.remove('s'),3000);
}

// â”€â”€â”€ KEYBOARD â”€â”€â”€
// Arrow key continuous pan
const keyState={};
let panLoop=null;
const PAN_SPEED=8;

function startPanLoop(){
  if(panLoop)return;
  panLoop=requestAnimationFrame(function tick(){
    let dx=0,dy=0;
    if(keyState['ArrowLeft'])dx+=PAN_SPEED;
    if(keyState['ArrowRight'])dx-=PAN_SPEED;
    if(keyState['ArrowUp'])dy+=PAN_SPEED;
    if(keyState['ArrowDown'])dy-=PAN_SPEED;
    // Shift = 3x speed
    if(keyState['Shift']){dx*=3;dy*=3;}
    if(dx||dy){S.px+=dx;S.py+=dy;applyT();}
    if(keyState['ArrowLeft']||keyState['ArrowRight']||keyState['ArrowUp']||keyState['ArrowDown']){
      panLoop=requestAnimationFrame(tick);
    }else{panLoop=null;}
  });
}

document.onkeydown=e=>{
  if(e.target.tagName==='TEXTAREA'||e.target.tagName==='INPUT')return;
  
  // Arrow keys â†’ pan image
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
    e.preventDefault();
    keyState[e.key]=true;
    if(e.shiftKey)keyState['Shift']=true;
    startPanLoop();
    return;
  }
  
  if(e.key==='b')document.querySelector('[data-tool="brush"]').click();
  if(e.key==='r')document.querySelector('[data-tool="rect"]').click();
  if(e.key==='e')document.querySelector('[data-tool="eraser"]').click();
  if(e.key==='z'&&(e.ctrlKey||e.metaKey)){e.preventDefault();$('undoB').click();}
  if(e.key==='+'||e.key==='=')zm(1.2);
  if(e.key==='-')zm(0.8);
  if(e.key==='0')$('zfB').click(); // 0 = fit to screen
};

document.onkeyup=e=>{
  keyState[e.key]=false;
  if(e.key==='Shift')keyState['Shift']=false;
};

// ê¸°ë³¸ API í‚¤ê°€ ìˆìœ¼ë©´ ìƒíƒœ í‘œì‹œë“± ì´ˆê¸°í™”
if($('apiKey').value.trim().length>10){$('dot').classList.add('on');}
upBtn();
</script>
</body>
</html>
